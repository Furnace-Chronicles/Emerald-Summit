## Equipment Phase Flow (What Runs During Equipment)

### 1. ticker.dm/equip_characters() [ENTRY POINT]
- Loops through 79 players
- Calls SSjob.EquipRank() for each
- CHECK_TICK every player (allows other procs to run)
- Logs: EQUIP START, EQUIP PROGRESS, EQUIP COMPLETE

### 2. job.dm/EquipRank() [PER PLAYER]
**Landmark Selection:**
- Loops through GLOB.start_landmarks_list to find spawn point
- For stackable jobs (Adventurer/Merc/Wretch/Bandit): Can use same landmark
- For regular jobs: Checks if landmark.used or has mob in loc
- ❌ BUG: Old code had fallback loop picking ANY landmark (recursion risk)

**Job Equipment:**
- Calls job.equip(H) - puts on clothes/gear
- ❌ POTENTIAL HANG: job.equip() calls H.equipOutfit() which can be slow

**Post-Equipment:**
- Calls job.after_spawn(H, M)
  - Adds job traits
  - Adds spells to mind
  - Changes stats
  - ⚠️ CALLS populate_job_knowledge() - loops through ALL players
  - Registers COMSIG_JOB_EQUIPPED signal handler
  - Creates bank account if give_bank_account
  - Announces latejoin

- Sends COMSIG_JOB_EQUIPPED signal (for jobs without advclasses)

### 3. _job.dm/populate_job_knowledge() [RUNS FOR EACH PLAYER]
**What it does:**
- For latejoin: Adds new player to SSjob.job_minds_cache
- Loops through universal_known_jobs (nobles)
  - For each noble job, loops through ALL minds in that job
  - Calls H.mind.i_know_person() for each
- If give_bank_account:
  - Loops through peopleknowme list
    - For each job, loops through ALL minds
    - Calls H.mind.person_knows_me() if target has give_bank_account
  - Loops through peopleiknow list
    - For each job, loops through ALL minds
    - Calls H.mind.i_know_person() if target has give_bank_account

**⚠️ SCALING ISSUE:**
- Player 1: Checks ~79 players
- Player 10: Checks ~79 players
- Player 79: Checks ~79 players
- Total: 79 × 79 = **6,241 loop iterations** just for knowledge population
- Each iteration calls i_know_person() which modifies lists

### 4. mind.dm/i_know_person() [CALLED ~6,241 TIMES]
**What it does:**
- Calls person.get_role_title() to get job name
- Stores person in mind.known_people associative list
- Caches voice, gender, species, age

**Potential hang point:** List operations on large associative lists

### 5. Signals Fired During Equipment
- COMSIG_JOB_RECEIVED (beginning of EquipRank)
- COMSIG_GLOB_JOB_AFTER_SPAWN (in after_spawn)
- COMSIG_JOB_EQUIPPED (end of EquipRank, or from finish_class_handler)

### 6. What DOESN'T Run Yet
- SSplayer_data_loader.queue_player() - only called in client_procs.dm on login
- ❌ No batch loading during roundstart equipment
- ❌ Players connecting AFTER equipment phase queue their data

## Likely Hang Causes (In Order)

1. **populate_job_knowledge() O(n²) scaling** - 6,241 iterations
   - Each player loops through all other players multiple times
   - List operations on known_people associative lists
   - get_role_title() calls for every relationship

2. **H.equipOutfit() / job.equip()** - Can be slow for complex jobs
   - Lots of item creation and attachment
   - Inventory management
   - Clothing application

3. **Landmark loop spam** - Now fixed with stackable jobs
   - Was iterating repeatedly when landmarks missing
   - Now limited to 1 log per rank

4. **CHECK_TICK in equipment loop** - Actually HELPS prevent hangs
   - Allows other procs to run between players
   - Not the cause

## What's NOT Causing the Hang

- Batch loader - doesn't run during equipment phase
- File I/O - only happens on individual client login, not during equipment
- COMSIG_JOB_EQUIPPED handlers - minimal work
